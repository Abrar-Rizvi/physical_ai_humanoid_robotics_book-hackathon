openapi: 3.0.3
info:
  title: Course AI Chat Widget API
  description: |
    REST API for the Course AI Chat Widget, enabling students to ask questions
    about course content with context-aware responses powered by Claude via MCP.
  version: 1.0.0
  contact:
    name: Course AI Chat Widget Team
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.example.com/api/v1
    description: Production server
  - url: http://localhost:8000/api/v1
    description: Development server

tags:
  - name: chat
    description: Chat operations
  - name: health
    description: Health check endpoints

paths:
  /chat:
    post:
      summary: Send a chat message
      description: |
        Processes a user query with page context and returns an AI-generated response
        based on the course book content. Uses RAG (Retrieval-Augmented Generation)
        with Claude via the context7 MCP server.
      operationId: sendChatMessage
      tags:
        - chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              basicQuery:
                summary: Basic query without session ID
                value:
                  user_query: "What is ROS 2?"
                  page_context:
                    title: "Chapter 3: ROS 2 Fundamentals"
                    pathname: "/docs/chapter-3"
              queryWithSession:
                summary: Query with session tracking
                value:
                  user_query: "Can you explain nodes in more detail?"
                  page_context:
                    title: "Chapter 3: ROS 2 Fundamentals"
                    pathname: "/docs/chapter-3"
                    section: "ros2-nodes"
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                successfulResponse:
                  summary: Successful AI response with sources
                  value:
                    response_text: "ROS 2 (Robot Operating System 2) is a flexible framework for writing robot software. It provides services including hardware abstraction, device drivers, libraries, visualizers, message-passing, and package management."
                    sources:
                      - title: "Chapter 3, Section 1: Introduction to ROS 2"
                        url: "/docs/chapter-3#introduction"
                      - title: "Chapter 3, Section 2: ROS 2 Architecture"
                        url: "/docs/chapter-3#architecture"
                    metadata:
                      processing_time_ms: 1234
                      model_used: "claude-sonnet-4"
                      tokens_used: 450
                responseWithoutSources:
                  summary: Response without source references
                  value:
                    response_text: "I don't have specific information about that topic in the current chapter. Could you try rephrasing your question or check another section?"
                    sources: []
                    metadata:
                      processing_time_ms: 567
                      model_used: "claude-sonnet-4"
        '400':
          description: Bad request - validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emptyQuery:
                  summary: Empty user query
                  value:
                    error: "Validation error"
                    detail: "user_query cannot be empty"
                    code: "VALIDATION_ERROR"
                queryTooLong:
                  summary: Query exceeds maximum length
                  value:
                    error: "Validation error"
                    detail: "user_query must be at most 500 characters"
                    code: "VALIDATION_ERROR"
                invalidPathname:
                  summary: Invalid pathname format
                  value:
                    error: "Validation error"
                    detail: "pathname must start with '/'"
                    code: "VALIDATION_ERROR"
        '429':
          description: Rate limit exceeded
          headers:
            X-RateLimit-Limit:
              description: Maximum requests per minute
              schema:
                type: integer
                example: 10
            X-RateLimit-Remaining:
              description: Remaining requests in current window
              schema:
                type: integer
                example: 0
            X-RateLimit-Reset:
              description: Unix timestamp when rate limit resets
              schema:
                type: integer
                example: 1702123500
            Retry-After:
              description: Seconds until rate limit resets
              schema:
                type: integer
                example: 30
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Rate limit exceeded"
                detail: "Too many requests. Please wait 30 seconds."
                code: "RATE_LIMIT_EXCEEDED"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Internal server error"
                detail: "An unexpected error occurred while processing your request"
                code: "INTERNAL_ERROR"
        '503':
          description: Service unavailable (MCP server down)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Service unavailable"
                detail: "AI assistant temporarily unavailable. Please try again later."
                code: "SERVICE_UNAVAILABLE"

  /health:
    get:
      summary: Health check
      description: Returns the health status of the API and its dependencies
      operationId: healthCheck
      tags:
        - health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                timestamp: 1702123456789
                services:
                  mcp: "connected"
                  claude: "operational"
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "unhealthy"
                timestamp: 1702123456789
                services:
                  mcp: "disconnected"
                  claude: "operational"

components:
  schemas:
    ChatRequest:
      type: object
      required:
        - user_query
        - page_context
      properties:
        user_query:
          type: string
          minLength: 1
          maxLength: 500
          description: The user's question or message
          example: "What is ROS 2?"
        page_context:
          $ref: '#/components/schemas/PageContext'
        session_id:
          type: string
          format: uuid
          description: Optional session identifier for tracking conversation context
          example: "550e8400-e29b-41d4-a716-446655440000"

    PageContext:
      type: object
      required:
        - title
        - pathname
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: The current page title (from document.title)
          example: "Chapter 3: ROS 2 Fundamentals - Physical AI Book"
        pathname:
          type: string
          minLength: 1
          maxLength: 200
          pattern: '^/.*'
          description: The current page pathname (must start with '/')
          example: "/docs/chapter-3"
        section:
          type: string
          maxLength: 100
          description: Optional section identifier within the page
          example: "ros2-architecture"

    ChatResponse:
      type: object
      required:
        - response_text
      properties:
        response_text:
          type: string
          minLength: 1
          maxLength: 4000
          description: The AI-generated response to the user's query
          example: "ROS 2 is a flexible framework for writing robot software..."
        sources:
          type: array
          maxItems: 5
          items:
            $ref: '#/components/schemas/Source'
          description: Optional array of source references from the book
          default: []
        metadata:
          $ref: '#/components/schemas/ResponseMetadata'

    Source:
      type: object
      required:
        - title
        - url
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 100
          description: Human-readable title of the source section
          example: "Chapter 3, Section 2: ROS 2 Architecture"
        url:
          type: string
          minLength: 1
          maxLength: 200
          description: Relative URL to the source section
          example: "/docs/chapter-3#architecture"

    ResponseMetadata:
      type: object
      description: Optional metadata about response generation (for debugging/monitoring)
      properties:
        processing_time_ms:
          type: integer
          minimum: 0
          description: Backend processing time in milliseconds
          example: 1234
        model_used:
          type: string
          description: Claude model identifier
          example: "claude-sonnet-4"
        tokens_used:
          type: integer
          minimum: 0
          description: Approximate number of tokens used
          example: 450

    ErrorResponse:
      type: object
      required:
        - error
        - detail
        - code
      properties:
        error:
          type: string
          description: High-level error category
          example: "Validation error"
        detail:
          type: string
          description: Detailed error message
          example: "user_query cannot be empty"
        code:
          type: string
          enum:
            - VALIDATION_ERROR
            - RATE_LIMIT_EXCEEDED
            - INTERNAL_ERROR
            - SERVICE_UNAVAILABLE
            - UNAUTHORIZED
          description: Machine-readable error code
          example: "VALIDATION_ERROR"

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum:
            - healthy
            - unhealthy
          description: Overall service health status
          example: "healthy"
        timestamp:
          type: integer
          description: Unix timestamp (ms) when health check was performed
          example: 1702123456789
        services:
          type: object
          description: Health status of dependencies
          properties:
            mcp:
              type: string
              enum:
                - connected
                - disconnected
              example: "connected"
            claude:
              type: string
              enum:
                - operational
                - degraded
                - unavailable
              example: "operational"

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Optional API key for authentication (if implemented)

security: []  # No authentication required for MVP

# Additional metadata
x-rate-limits:
  chat:
    - name: IP-based rate limit
      limit: 10
      window: 60s
      scope: IP address
    - name: Session-based rate limit (optional)
      limit: 5
      window: 60s
      scope: session_id

x-cors:
  allowed-origins:
    - https://devabdullah90.github.io
    - http://localhost:3000
  allowed-methods:
    - POST
    - OPTIONS
  allowed-headers:
    - Content-Type
    - X-API-Key
  max-age: 3600
